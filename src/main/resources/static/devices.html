<!doctype html>
<html lang="zh-CN">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Device Management - IEMS</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <style>
        body {
            background: #f5f7fb;
            min-height: 100vh;
        }

        .sidebar {
            width: 240px;
            background: #ffffff;
            border-right: 1px solid #e9eef6;
            min-height: 100vh;
        }

        .brand {
            padding: 20px;
            font-weight: 600;
        }

        .nav-link.active {
            background: linear-gradient(90deg, rgba(99, 102, 241, 0.08), transparent);
            border-radius: 8px;
        }

        .content {
            padding: 24px;
        }

        .card {
            border-radius: 12px;
            box-shadow: 0 6px 20px rgba(20, 30, 50, 0.04);
        }

        .table-responsive {
            min-height: 400px;
        }

        .form-check-input:checked {
            background-color: #6366f1;
            border-color: #6366f1;
        }

        /* 列宽限制：当宽度不足时自动换行并自适应高度 */
        .table {
            width: 100%;
            table-layout: fixed;
            /* 使列宽更可控，配合 max-width 使用 */
        }

        .table th,
        .table td {
            max-width: 220px;
            /* 单列最大宽度，按需调整 */
            white-space: normal;
            /* 允许换行 */
            overflow-wrap: anywhere;
            /* 更灵活地在任意位置换行长字符串 */
            word-break: break-word;
            /* 兼容性换行策略 */
            vertical-align: top;
            /* 多行时顶对齐 */
        }

        /* 对操作列和时间列可以单独放宽或收窄 */
        .table th:last-child,
        .table td:last-child {
            max-width: 160px;
        }

        /* ----------------- 详情弹窗与内容换行（与 permissions / operators 保持一致） ----------------- */
        /* 限制 detail modal 最大宽度（在不同断点可调整） */
        #deviceDetailModal .modal-dialog {
            max-width: 560px;
            margin: 1.75rem auto;
        }

        /* 保证 modal-body 内文本 / 长字符串换行，不撑破布局 */
        #deviceDetailModal .modal-content,
        #deviceDetailModal .modal-body,
        #deviceDetailModal #deviceDetailBody {
            white-space: normal !important;
            word-break: break-word;
            overflow-wrap: anywhere;
        }

        /* Device detail: use the same compact inline label:value rows as operators/permissions */
        #deviceDetailBody > div {
            margin-bottom: 6px;
            line-height: 1.3;
        }

        #deviceDetailBody > div strong {
            display: inline-block;
            font-weight: 600;
        }

        /* detail 中的表格列也限制宽度并允许换行 */
        #deviceDetailModal table th,
        #deviceDetailModal table td {
            max-width: 420px;
            white-space: normal;
            word-break: break-word;
            overflow-wrap: anywhere;
            vertical-align: top;
        }

        @media (max-width: 480px) {
            #deviceDetailModal .modal-dialog {
                max-width: 92%;
            }
        }

        /* ----------------------------------------------------------------------- */
    </style>
</head>

<body>
    <div class="d-flex">
        <div id="sidebarContainer"></div>

        <div class="flex-grow-1 content">
            <div class="container-fluid">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <div>
                        <h1 class="h3 mb-0">设备管理</h1>
                        <p class="text-muted small mb-0">创建、查看、更新设备</p>
                    </div>
                    <div>
                        <button class="btn btn-outline-secondary me-2" type="button" data-bs-toggle="collapse"
                            data-bs-target="#searchCollapse" aria-expanded="false" aria-controls="searchCollapse">
                            <i class="bi bi-search"></i> 查询
                        </button>
                        <button class="btn btn-primary" onclick="prepareCreateForm()">
                            <i class="bi bi-plus-lg me-2"></i>创建设备
                        </button>
                    </div>
                </div>

                <div class="collapse mb-4" id="searchCollapse">
                    <div class="card">
                        <div class="card-body">
                            <form id="searchForm" class="row g-3 align-items-end">
                                <div class="col-md-3">
                                    <label for="searchUuid" class="form-label">UUID</label>
                                    <input type="text" class="form-control" id="searchUuid">
                                </div>
                                <div class="col-md-3">
                                    <label for="searchMacAddress" class="form-label">MAC 地址</label>
                                    <input type="text" class="form-control" id="searchMacAddress">
                                </div>
                                <div class="col-md-3">
                                    <label for="searchModel" class="form-label">型号</label>
                                    <input type="text" class="form-control" id="searchModel">
                                </div>
                                <div class="col-md-3">
                                    <label for="searchBrand" class="form-label">品牌</label>
                                    <input type="text" class="form-control" id="searchBrand">
                                </div>
                                <div class="col-md-3">
                                    <label for="searchSerialno" class="form-label">序列号</label>
                                    <input type="text" class="form-control" id="searchSerialno">
                                </div>
                                <div class="col-md-2">
                                    <label for="searchActive" class="form-label">激活状态</label>
                                    <select id="searchActive" class="form-select">
                                        <option value="">全部</option>
                                        <option value="true">已激活</option>
                                        <option value="false">未激活</option>
                                    </select>
                                </div>
                                <div class="col-md-2">
                                    <label for="searchLocked" class="form-label">锁定状态</label>
                                    <select id="searchLocked" class="form-select">
                                        <option value="">全部</option>
                                        <option value="true">已锁定</option>
                                        <option value="false">未锁定</option>
                                    </select>
                                </div>
                                <div class="col-md-5 d-flex align-items-end">
                                    <div class="me-3 d-flex align-items-center">
                                        <div class="form-check form-switch me-3 mb-0">
                                            <input class="form-check-input" type="checkbox" role="switch" id="fuzzySearch" aria-checked="false">
                                            <label class="form-check-label small" for="fuzzySearch">模糊查询</label>
                                        </div>
                                    </div>
                                    <button type="button" class="btn btn-primary me-2" onclick="handleSearch()">搜索</button>
                                    <button type="button" class="btn btn-secondary" onclick="handleReset()">重置</button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>

                <div class="card">
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-hover">
                                <thead>
                                    <tr>
                                        <th>ID</th>
                                        <th>MAC 地址</th>
                                        <th>型号</th>
                                        <th>品牌</th>
                                        <th>序列号</th>
                                        <th>激活</th>
                                        <th>锁定</th>
                                        <th>创建时间</th>
                                        <th>更新时间</th>
                                        <th>操作</th>
                                    </tr>
                                </thead>
                                <tbody id="devicesTableBody">
                    <!-- Device rows will be inserted here -->
                </tbody>
                            </table>
                        </div>
                        <nav>
                            <ul class="pagination justify-content-end" id="pagination">
                                <!-- Pagination items will be inserted here -->
                            </ul>
                        </nav>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Device Modal (Create/Edit) -->
    <div class="modal fade" id="deviceModal" tabindex="-1" aria-labelledby="deviceModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="deviceModalLabel">创建设备</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="deviceForm">
                        <input type="hidden" id="deviceId">
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="macAddress" class="form-label">MAC 地址 <span class="text-danger">*</span></label>
                                <input type="text" class="form-control" id="macAddress" required>
                            </div>
                            <div class="col-md-6 mb-3" id="signature-hash-group">
                                <label for="signatureHash" class="form-label">签名哈希 <span class="text-danger">*</span></label>
                                <input type="text" class="form-control" id="signatureHash" required>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="model" class="form-label">型号</label>
                                <input type="text" class="form-control" id="model">
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="brand" class="form-label">品牌</label>
                                <input type="text" class="form-control" id="brand">
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="serialno" class="form-label">序列号</label>
                                <input type="text" class="form-control" id="serialno">
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="androidVersion" class="form-label">Android 版本</label>
                                <input type="text" class="form-control" id="androidVersion">
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="appVersion" class="form-label">App 版本</label>
                                <input type="text" class="form-control" id="appVersion">
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="romVersion" class="form-label">ROM 版本</label>
                                <input type="text" class="form-control" id="romVersion">
                            </div>
                            <div class="col-md-6 mb-3 d-flex align-items-center">
                                <div class="form-check form-switch me-4">
                                    <input class="form-check-input" type="checkbox" role="switch" id="active" checked>
                                    <label class="form-check-label" for="active">激活</label>
                                </div>
                                <div class="form-check form-switch">
                                    <input class="form-check-input" type="checkbox" role="switch" id="locked">
                                    <label class="form-check-label" for="locked">锁定</label>
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                    <button type="button" class="btn btn-primary" onclick="saveDevice()">保存</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Device Permissions Modal -->
    <div class="modal fade" id="devicePermissionsModal" tabindex="-1" aria-labelledby="devicePermissionsModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="devicePermissionsModalLabel">管理设备权限</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <input type="hidden" id="permissionDeviceId">
                    <p>为设备 <strong id="permissionDeviceName"></strong> 分配权限:</p>
                    <div id="permissionsCheckboxesDevice">
                        <!-- Checkboxes will be loaded here -->
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                    <button type="button" class="btn btn-primary" onclick="saveDevicePermissions()">保存权限</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Device Detail Modal -->
    <div class="modal fade" id="deviceDetailModal" tabindex="-1" aria-labelledby="deviceDetailModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered modal-sm">
             <div class="modal-content">
                 <div class="modal-header">
                     <h5 class="modal-title" id="deviceDetailModalLabel">设备详情</h5>
                     <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                 </div>
                 <div class="modal-body">
                    <div id="deviceDetailBody" class="small"></div>
                 </div>
                 <div class="modal-footer">
                     <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">关闭</button>
                 </div>
             </div>
         </div>
     </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        const API_BASE = '/api';
        const accessToken = localStorage.getItem('accessToken');
        let currentPage = 0;
        const pageSize = 10;
        let currentSearchQuery = null;
        // Permission group for devices (self permissions)
        const PERMISSION_GROUPS = {
            DEVICE_SELF: ['device:write:self', 'device:update:self', 'device:read:self']
        };
        const ALL_PERMISSION_GROUP_KEYS = Object.keys(PERMISSION_GROUPS);
        
        // --- Search / Reset (支持精确 / 模糊查询，与 operators 保持一致) ---
        function handleSearch() {
            const isFuzzy = document.getElementById('fuzzySearch')?.checked;
            const getVal = id => (document.getElementById(id)?.value || '').trim();

            const uuid = getVal('searchUuid');
            const macAddress = getVal('searchMacAddress');
            const model = getVal('searchModel');
            const brand = getVal('searchBrand');
            const serialno = getVal('searchSerialno');
            const active = getVal('searchActive');
            const locked = getVal('searchLocked');

            const addQuery = (field, value) => {
                if (!value) return;
                const key = isFuzzy ? `${field}Like` : field;
                const val = isFuzzy ? `%${value}%` : value;
                currentSearchQuery[key] = val;
            };

            currentSearchQuery = {};
            addQuery('uuid', uuid);
            addQuery('macAddress', macAddress);
            addQuery('model', model);
            addQuery('brand', brand);
            addQuery('serialno', serialno);
            if (active !== '') currentSearchQuery.active = active === 'true';
            if (locked !== '') currentSearchQuery.locked = locked === 'true';

            if (Object.keys(currentSearchQuery).length === 0) currentSearchQuery = null;
            fetchDevices(0);
        }

        function handleReset() {
            document.getElementById('searchForm').reset();
            currentSearchQuery = null;
            fetchDevices(0);
        }

        function humanLabel(perm) {
            const parts = perm.split(':');
            if (parts.length === 1) return perm;
            const group = parts[0].charAt(0).toUpperCase() + parts[0].slice(1);
            const action = parts[1].split('.').join(' ').split('_').map(s => s.charAt(0).toUpperCase() + s.slice(1)).join(' ');
            return `${group} · ${action}`;
        }

        // --- Authentication & Sidebar ---
        if (!accessToken) {
            window.location.href = '/login.html';
        }

        (async function loadSidebar() {
            try {
                const response = await fetch('/sidebar.html');
                if (!response.ok) throw new Error('Failed to load sidebar');
                const sidebarHtml = await response.text();
                document.getElementById('sidebarContainer').innerHTML = sidebarHtml;
                // Highlight the active link
                const navLinks = document.querySelectorAll('.nav-link');
                navLinks.forEach(link => {
                    if (link.href.endsWith('devices.html')) {
                        link.classList.add('active');
                    }
                });
            } catch (e) {
                console.error('Sidebar load error:', e);
            }
        })();

        // --- Token refresh helpers ---
        let refreshPromise = null;

        function getAccessToken() {
            return localStorage.getItem('accessToken') || '';
        }

        async function refreshAccessToken() {
            // If a refresh is already in progress, reuse it (avoids concurrent refreshes)
            if (refreshPromise) return refreshPromise;
            refreshPromise = (async () => {
                const rt = localStorage.getItem('refreshToken');
                if (!rt) throw new Error('No refresh token available');

                const res = await fetch(`${API_BASE}/auth/refresh`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ refreshToken: rt })
                });

                if (!res.ok) {
                    // Clear tokens and throw, the caller will handle redirecting to login
                    localStorage.removeItem('accessToken');
                    localStorage.removeItem('refreshToken');
                    throw new Error('Refresh token invalid or expired');
                }

                const data = await res.json();
                if (!data || !data.accessToken) {
                    throw new Error('Invalid response from token refresh');
                }

                // Update local storage
                localStorage.setItem('accessToken', data.accessToken);
                if (data.refreshToken) {
                    localStorage.setItem('refreshToken', data.refreshToken);
                }
                return data.accessToken;
            })().finally(() => { refreshPromise = null; });

            return refreshPromise;
        }


        // --- API Helper with refresh-on-401 and retry ---
        async function apiFetch(url, options = {}) {
            // Always get the latest token for the request
            const baseHeaders = {
                'Content-Type': 'application/json',
                ...(getAccessToken() ? { 'Authorization': `Bearer ${getAccessToken()}` } : {})
            };
            const mergedOptions = { ...options, headers: { ...baseHeaders, ...(options.headers || {}) } };

            let response = await fetch(url, mergedOptions);

            // If unauthorized (401), try to refresh the token and retry the request once.
            if (response.status === 401) {
                try {
                    await refreshAccessToken(); // This might throw an error
                    // Rebuild headers with the new token and retry
                    const retryHeaders = {
                        'Content-Type': 'application/json',
                        ...(getAccessToken() ? { 'Authorization': `Bearer ${getAccessToken()}` } : {})
                    };
                    response = await fetch(url, { ...options, headers: { ...retryHeaders, ...(options.headers || {}) } });
                } catch (refreshErr) {
                    // If refresh fails, force a redirect to the login page
                    console.error('Session expired, redirecting to login.', refreshErr);
                    alert('会话已过期，请重新登录。');
                    window.location.href = '/login.html';
                    throw refreshErr; // Stop further execution
                }
            }

            const responseText = await response.text();

            if (!response.ok) {
                // If still not OK after retry, throw an error for the caller to handle
                throw new Error(responseText || `API Error: ${response.status}`);
            }

            const contentType = response.headers.get("content-type");
            if (contentType && contentType.includes("application/json")) {
                try {
                    return JSON.parse(responseText);
                } catch (e) {
                    console.error("Failed to parse JSON response:", e);
                    return responseText; // Return as text if parsing fails
                }
            }
            return responseText;
        }

        // --- Date Time Helper ---
        function formatDateTime(isoString) {
            if (!isoString) return '-';
            try {
                const date = new Date(isoString);
                const year = date.getFullYear();
                const month = (date.getMonth() + 1).toString().padStart(2, '0');
                const day = date.getDate().toString().padStart(2, '0');
                const hours = date.getHours().toString().padStart(2, '0');
                const minutes = date.getMinutes().toString().padStart(2, '0');
                const seconds = date.getSeconds().toString().padStart(2, '0');
                return `${year}-${month}-${day} ${hours}:${minutes}:${seconds}`;
            } catch {
                return isoString;
            }
        }

        async function fetchDevices(page = 0) {
            currentPage = page;
            const offset = page * pageSize;
            const queryLimit = pageSize + 1;

            let url = `${API_BASE}/admin/devices?offset=${offset}&limit=${queryLimit}`;
            let options = { method: 'GET' };

            if (currentSearchQuery && Object.keys(currentSearchQuery).length > 0) {
                url = `${API_BASE}/admin/devices/query`;
                options = {
                    method: 'POST',
                    body: JSON.stringify({ ...currentSearchQuery, offset, limit: queryLimit })
                };
            }

            try {
                const data = await apiFetch(url, options);
                const hasNextPage = data.length > pageSize;
                const devices = data.slice(0, pageSize);

                const tableBody = document.getElementById('devicesTableBody');
                devices.forEach(device => {
                    console.log("Fetched device:", device);
                });
                
                tableBody.innerHTML = devices.map(device => `
                     <tr>
                         <td>${device.id}</td>
                         <td>${device.macAddress || '-'}</td>
                         <td>${device.model || '-'}</td>
                         <td>${device.brand || '-'}</td>
                         <td>${device.serialno || '-'}</td>
                         <td><span class="badge ${device.active ? 'bg-success' : 'bg-secondary'}">${device.active ? '是' : '否'}</span></td>
                         <td><span class="badge ${device.locked ? 'bg-danger' : 'bg-secondary'}">${device.locked ? '是' : '否'}</span></td>
                         <td>${formatDateTime(device.createdAt)}</td>
                         <td>${formatDateTime(device.updatedAt)}</td>
                         <td>
                             <div class="btn-group">
                                <button class="btn btn-sm btn-outline-info" onclick='showDeviceDetails("${device.id}")' title="详情"><i class="bi bi-eye"></i></button>
                                <button class="btn btn-sm btn-outline-secondary" onclick='manageDevicePermissions("${device.id}", "${device.uuid}")' title="管理权限"><i class="bi bi-shield-lock"></i></button>
                                 <button class="btn btn-sm btn-outline-primary" onclick='prepareEditForm(${JSON.stringify(device)})' title="编辑"><i class="bi bi-pencil"></i></button>
                                 <button class="btn btn-sm btn-outline-danger" onclick="deleteDevice('${device.id}')" title="删除"><i class="bi bi-trash"></i></button>
                             </div>
                         </td>
                     </tr>
                 `).join('');
                setupPagination(hasNextPage);
            } catch (error) {
                console.error('Failed to fetch devices:', error);
                document.getElementById('devicesTableBody').innerHTML = `<tr><td colspan="11" class="text-center text-danger">加载设备失败: ${error.message}</td></tr>`;
            }
        }

        function prepareCreateForm() {
            document.getElementById('deviceModalLabel').textContent = '创建设备';
            document.getElementById('deviceForm').reset();
            document.getElementById('deviceId').value = '';
            document.getElementById('signature-hash-group').style.display = 'block';
            document.getElementById('macAddress').readOnly = false;
            document.getElementById('signatureHash').required = true;
            document.getElementById('active').checked = true;
            document.getElementById('locked').checked = false;
            new bootstrap.Modal(document.getElementById('deviceModal')).show();
        }

        function prepareEditForm(device) {
            document.getElementById('deviceModalLabel').textContent = '编辑设备';
            document.getElementById('deviceForm').reset();
            document.getElementById('deviceId').value = device.id;
            document.getElementById('macAddress').value = device.macAddress;
            document.getElementById('macAddress').readOnly = true; // MAC address is often an identifier, not for editing
            document.getElementById('model').value = device.model;
            document.getElementById('brand').value = device.brand;
            document.getElementById('serialno').value = device.serialno;
            document.getElementById('androidVersion').value = device.androidVersion;
            document.getElementById('appVersion').value = device.appVersion;
            document.getElementById('romVersion').value = device.romVersion;
            document.getElementById('active').checked = device.active;
            document.getElementById('locked').checked = device.locked;
            document.getElementById('signature-hash-group').style.display = 'none';
            document.getElementById('signatureHash').required = false;
            new bootstrap.Modal(document.getElementById('deviceModal')).show();
        }

        async function saveDevice() {
            const id = document.getElementById('deviceId').value;
            const isEdit = !!id;
            const url = isEdit ? `${API_BASE}/admin/devices/${id}` : `${API_BASE}/admin/devices`;
            const method = isEdit ? 'PUT' : 'POST';

            const body = {
                model: document.getElementById('model').value,
                brand: document.getElementById('brand').value,
                serialno: document.getElementById('serialno').value,
                androidVersion: document.getElementById('androidVersion').value,
                appVersion: document.getElementById('appVersion').value,
                romVersion: document.getElementById('romVersion').value,
                active: document.getElementById('active').checked,
                locked: document.getElementById('locked').checked,
            };

            if (!isEdit) {
                body.macAddress = document.getElementById('macAddress').value;
                body.signatureHash = document.getElementById('signatureHash').value;
                if (!body.macAddress || !body.signatureHash) {
                    alert('MAC 地址和签名哈希是必填项。');
                    return;
                }
            }

            try {
                await apiFetch(url, { method, body: JSON.stringify(body) });
                bootstrap.Modal.getInstance(document.getElementById('deviceModal')).hide();
                fetchDevices(isEdit ? currentPage : 0);
            } catch (error) {
                console.error('Failed to save device:', error);
                alert(`保存设备失败: ${error.message}`);
            }
        }

        async function deleteDevice(id) {
            if (!confirm(`确定要删除 ID 为 ${id} 的设备吗？此操作不可逆。`)) return;
            try {
                await apiFetch(`${API_BASE}/admin/devices/${id}`, { method: 'DELETE' });
                fetchDevices(currentPage);
            } catch (error) {
                console.error('Failed to delete device:', error);
                alert(`删除设备失败: ${error.message}`);
            }
        }

        // --- Device permission management (类似 operators 的设计，但仅针对设备自身三项权限) ---
        async function manageDevicePermissions(deviceId, deviceUuid) {
            document.getElementById('permissionDeviceId').value = deviceId;
            document.getElementById('permissionDeviceName').textContent = deviceUuid;

            const checkboxesContainer = document.getElementById('permissionsCheckboxesDevice');
            checkboxesContainer.innerHTML = '加载中...';

            const modal = new bootstrap.Modal(document.getElementById('devicePermissionsModal'));
            modal.show();

            try {
                // 请求当前设备权限（复用 admin/permissions/query 接口，传入 deviceId）
                const response = await apiFetch(`${API_BASE}/admin/permissions/query?limit=1&offset=0&deviceId=${deviceId}`);
                const currentPermission = response[0];
                const activePermissions = (currentPermission && currentPermission.permissions)
                    ? currentPermission.permissions.split(',').map(p => p.trim().toLowerCase()).filter(Boolean)
                    : [];

                checkboxesContainer.innerHTML = '';
                ALL_PERMISSION_GROUP_KEYS.forEach(groupKey => {
                    const perms = PERMISSION_GROUPS[groupKey];
                    const groupId = `perm-group-${groupKey}`;
                    let groupHtml = `<div class="mb-3"><strong>${groupKey}</strong><div class="ps-3" id="${groupId}">`;
                    perms.forEach(perm => {
                        const idSafe = `perm-${perm.replace(/[:/]/g, '_')}`;
                        const checked = activePermissions.includes(perm.toLowerCase()) ? 'checked' : '';
                        groupHtml += `
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" value="${perm}" id="${idSafe}" ${checked}>
                                <label class="form-check-label" for="${idSafe}">${humanLabel(perm)}</label>
                            </div>
                        `;
                    });
                    groupHtml += `</div></div>`;
                    checkboxesContainer.insertAdjacentHTML('beforeend', groupHtml);
                });
            } catch (error) {
                console.error('manageDevicePermissions error:', error);
                checkboxesContainer.innerHTML = `<div class="alert alert-danger">加载权限失败: ${error && error.message ? error.message : '未知错误'}</div>`;
            }
        }

        async function saveDevicePermissions() {
            const deviceId = document.getElementById('permissionDeviceId').value;
            const checkedBoxes = Array.from(document.querySelectorAll('#permissionsCheckboxesDevice input:checked'));
            const selectedPermissions = checkedBoxes.map(cb => cb.value.toLowerCase());
            const permissionToSet = selectedPermissions.length > 0 ? selectedPermissions.join(',') : "device:read:self";

            try {
                await apiFetch(`${API_BASE}/admin/permissions/${deviceId}`, {
                    method: 'PUT',
                    body: JSON.stringify(permissionToSet)
                });
                alert('权限更新成功。');
                bootstrap.Modal.getInstance(document.getElementById('devicePermissionsModal')).hide();
            } catch (error) {
                console.error('saveDevicePermissions error:', error);
                alert(`保存权限失败: ${error && error.message ? error.message : '未知错误'}`);
            }
        }

        // --- Pagination ---
        function setupPagination(hasNextPage) {
            const pagination = document.getElementById('pagination');
            pagination.innerHTML = `
                <li class="page-item ${currentPage === 0 ? 'disabled' : ''}">
                    <a class="page-link" href="#" onclick="fetchDevices(${currentPage - 1})">上一页</a>
                </li>
                <li class="page-item active"><a class="page-link" href="#">${currentPage + 1}</a></li>
                <li class="page-item ${!hasNextPage ? 'disabled' : ''}">
                    <a class="page-link" href="#" onclick="fetchDevices(${currentPage + 1})">下一页</a>
                </li>
            `;
        }

        // --- Initial Load ---
        document.addEventListener('DOMContentLoaded', () => {
            fetchDevices(0);
        });

        async function showDeviceDetails(deviceId) {
            const modalEl = document.getElementById('deviceDetailModal');
            const bodyEl = document.getElementById('deviceDetailBody');
            bodyEl.innerHTML = '加载中...';
            const modal = new bootstrap.Modal(modalEl);
            modal.show();
            try {
                const device = await apiFetch(`${API_BASE}/admin/devices/${encodeURIComponent(deviceId)}`);
                // Render same compact label:value layout used by operators/permissions pages
                bodyEl.innerHTML = `
                    <div><strong>ID:</strong> ${device.id ?? '-'}</div>
                    <div><strong>UUID:</strong> ${device.uuid ?? '-'}</div>
                    <div><strong>MAC 地址:</strong> ${device.macAddress ?? '-'}</div>
                    <div><strong>签名哈希:</strong> ${device.signatureHash ?? '-'}</div>
                    <div><strong>型号:</strong> ${device.model ?? '-'}</div>
                    <div><strong>品牌:</strong> ${device.brand ?? '-'}</div>
                    <div><strong>序列号:</strong> ${device.serialno ?? '-'}</div>
                    <div><strong>Android 版本:</strong> ${device.androidVersion ?? '-'}</div>
                    <div><strong>App 版本:</strong> ${device.appVersion ?? '-'}</div>
                    <div><strong>ROM 版本:</strong> ${device.romVersion ?? '-'}</div>
                    <div><strong>激活:</strong> ${device.active ? '是' : '否'}</div>
                    <div><strong>锁定:</strong> ${device.locked ? '是' : '否'}</div>
                    <div><strong>创建时间:</strong> ${formatDateTime(device.createdAt)}</div>
                    <div><strong>更新时间:</strong> ${formatDateTime(device.updatedAt)}</div>
                `;
             } catch (err) {
                 console.error('Failed to load device detail:', err);
                 bodyEl.innerHTML = `<div class="text-danger">加载失败: ${err.message || err}</div>`;
             }
         }
    </script>
</body>

</html>