<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>登录 - IEMS</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body { background:#f7fafc; }
    .card { border-radius:12px; box-shadow:0 6px 20px rgba(20,30,50,0.06); }
  </style>
</head>
<body>
  <div class="container d-flex align-items-center justify-content-center" style="min-height:100vh;">
    <div class="w-100" style="max-width:420px;">
      <div class="text-center mb-4">
        <h3 class="fw-bold">IEMS 管理平台</h3>
        <p class="text-muted small">请输入手机号和密码以登录</p>
      </div>

      <div class="card p-4">
        <form id="loginForm">
          <div class="mb-3">
            <label class="form-label">手机号</label>
            <input id="phone" type="text" class="form-control" required />
          </div>
          <div class="mb-3">
            <label class="form-label">密码</label>
            <input id="password" type="password" class="form-control" required />
          </div>
          <div class="d-grid">
            <button class="btn btn-primary" type="submit">登录</button>
          </div>
        </form>
        <div id="msg" class="mt-3 text-center text-danger small" style="display:none"></div>
      </div>
    </div>
  </div>

  <script>
    (async function precheckTokens(){
      try {
        const access = localStorage.getItem('accessToken');
        const refresh = localStorage.getItem('refreshToken');

        // 如果已有有效 accessToken，直接跳转（优先快速跳转以提升 UX）
        if (access) {
          // 尝试校验 accessToken 是否仍有效（可根据后端实际接口调整）
          try {
            const validateResp = await fetch('/api/auth/validate', {
              method: 'GET',
              headers: { 'Authorization': 'Bearer ' + access }
            });
            if (validateResp.ok) {
              window.location.href = '/dashboard.html';
              return;
            }
          } catch (e) {
            // 忽略校验错误，后面尝试使用 refreshToken
            console.debug('access token validate failed', e);
          }
        }

        // 若没有有效 accessToken，但有 refreshToken，尝试刷新并跳转
        if (refresh) {
          try {
            const resp = await fetch('/api/auth/refresh', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ refreshToken: refresh })
            });
            if (resp.ok) {
              const data = await resp.json();
              if (data.accessToken) localStorage.setItem('accessToken', data.accessToken);
              if (data.refreshToken) localStorage.setItem('refreshToken', data.refreshToken || refresh);
              window.location.href = '/dashboard.html';
              return;
            } else {
              // 刷新失败则清理本地 token，继续显示登录页
              localStorage.removeItem('accessToken');
              localStorage.removeItem('refreshToken');
            }
          } catch (e) {
            console.debug('refresh token failed', e);
            localStorage.removeItem('accessToken');
            localStorage.removeItem('refreshToken');
          }
        }
      } catch (e) {
        console.error('precheckTokens error', e);
      }
    })();

    const form = document.getElementById('loginForm');
    const msg = document.getElementById('msg');

    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      msg.style.display = 'none';
      const phone = document.getElementById('phone').value.trim();
      const password = document.getElementById('password').value;

      try {
        const resp = await fetch('/api/auth/login', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ phone, password })
        });

        if (!resp.ok) {
          const t = await resp.text();
          msg.textContent = t || '登录失败';
          msg.style.display = 'block';
          return;
        }

        const data = await resp.json();
        // 保存 access token（简易方案）
        localStorage.setItem('accessToken', data.accessToken);
        localStorage.setItem('refreshToken', data.refreshToken || '');
        // 跳转到 dashboard
        window.location.href = '/dashboard.html';
      } catch (err) {
        msg.textContent = '网络错误';
        msg.style.display = 'block';
      }
    });
  </script>
</body>
</html>