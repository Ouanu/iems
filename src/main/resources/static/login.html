<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>登录 - IEMS</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
  <link rel="stylesheet" href="/css/modern.css" />
  <style>
    .login-card .tagline {
      font-size: 0.95rem;
      color: var(--text-muted);
    }
    .login-card .form-label {
      font-weight: 500;
      color: var(--text-muted);
    }
  </style>
</head>
<body class="login-hero">
  <div class="login-card">
    <div class="brand">IEMS 管理平台</div>
    <p class="tagline mb-4">请输入手机号和密码以登录您的账户。</p>

    <form id="loginForm">
      <div class="mb-3">
        <label class="form-label" for="phone">手机号</label>
        <input id="phone" type="text" class="form-control" required />
      </div>
      <div class="mb-3">
        <label class="form-label" for="password">密码</label>
        <input id="password" type="password" class="form-control" required />
      </div>
      <div class="d-grid">
        <button class="btn btn-primary" type="submit">登录</button>
      </div>
    </form>
    <div class="login-meta mt-3">
      <span class="small text-muted">忘记密码请联系管理员</span>
      <i class="bi bi-shield-lock text-primary"></i>
    </div>
    <div id="msg" class="mt-3 text-center text-danger small" style="display:none"></div>
  </div>

  <script>
    async function redirectToDashboard() {
      window.location.href = '/dashboard.html';
    }

    async function tryValidateAccess(accessToken) {
      if (!accessToken) return false;
      try {
        const validateResp = await fetch('/api/auth/validate', {
          method: 'GET',
          headers: { 'Authorization': 'Bearer ' + accessToken }
        });
        if (validateResp.ok) {
          await redirectToDashboard();
          return true;
        }
      } catch (error) {
        console.debug('access token validate failed', error);
      }
      return false;
    }

    async function tryRefreshSession(refreshToken) {
      if (!refreshToken) return false;
      try {
        const resp = await fetch('/api/auth/refresh', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ refreshToken })
        });
        if (!resp.ok) {
          localStorage.removeItem('accessToken');
          localStorage.removeItem('refreshToken');
          return false;
        }
        const data = await resp.json();
        if (data.accessToken) localStorage.setItem('accessToken', data.accessToken);
        localStorage.setItem('refreshToken', data.refreshToken || refreshToken);
        await redirectToDashboard();
        return true;
      } catch (error) {
        console.debug('refresh token failed', error);
        localStorage.removeItem('accessToken');
        localStorage.removeItem('refreshToken');
        return false;
      }
    }

    (async function precheckTokens(){
      try {
        const access = localStorage.getItem('accessToken');
        const refresh = localStorage.getItem('refreshToken');
        if (await tryValidateAccess(access)) return;
        if (await tryRefreshSession(refresh)) return;
      } catch (error) {
        console.error('precheckTokens error', error);
      }
    })();

    const form = document.getElementById('loginForm');
    const msg = document.getElementById('msg');

    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      msg.style.display = 'none';
      const phone = document.getElementById('phone').value.trim();
      const password = document.getElementById('password').value;

      try {
        const resp = await fetch('/api/auth/login', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ phone, password })
        });

        if (!resp.ok) {
          const t = await resp.text();
          msg.textContent = t || '登录失败';
          msg.style.display = 'block';
          return;
        }

        const data = await resp.json();
        // 保存 access token（简易方案）
        localStorage.setItem('accessToken', data.accessToken);
        localStorage.setItem('refreshToken', data.refreshToken || '');
        // 跳转到 dashboard
        window.location.href = '/dashboard.html';
      } catch (err) {
        console.error('login request failed', err);
        msg.textContent = '网络错误';
        msg.style.display = 'block';
      }
    });
  </script>
</body>
</html>